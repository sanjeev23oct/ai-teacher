// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model QuestionPaper {
  id         String  @id @default(uuid())
  title      String? // Optional: "Math Final Exam 2024"
  subject    String // "Mathematics", "Physics", etc.
  gradeLevel String // "Grade 9-10"
  language   String // "English", "Hindi", etc.

  // Image storage
  imageUrl  String // URL or path to stored image
  imageHash String @unique // SHA-256 hash for deduplication

  // Extracted data
  questions      Question[]
  totalQuestions Int

  // Metadata
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  usageCount Int      @default(0) // How many times used

  // Relations
  gradings Grading[]

  @@index([imageHash])
  @@index([createdAt])
}

model Question {
  id              String        @id @default(uuid())
  questionPaperId String
  questionPaper   QuestionPaper @relation(fields: [questionPaperId], references: [id], onDelete: Cascade)

  // Question details
  questionNumber String // "1", "2", "3", etc.
  questionText   String  @db.Text
  maxScore       Float? // Optional: points for this question
  topic          String? // "Algebra", "Geometry", etc.
  concept        String? // "Linear Equations", etc.

  // Position in image (for annotations)
  positionX Float?
  positionY Float?

  // Metadata
  createdAt DateTime @default(now())

  @@unique([questionPaperId, questionNumber])
  @@index([questionPaperId])
}

model Grading {
  id String @id @default(uuid())

  // Question paper (optional - null for single image mode)
  questionPaperId String?
  questionPaper   QuestionPaper? @relation(fields: [questionPaperId], references: [id])

  // Answer sheet
  answerSheetUrl String // URL or path to answer sheet image

  // Results
  subject    String
  language   String
  gradeLevel String
  totalScore String
  feedback   String @db.Text

  // Matching info (for dual mode)
  matchingMode      String? // "single" | "dual"
  totalQuestions    Int?
  answeredQuestions Int?

  // Detailed analysis
  answers Answer[]

  // Metadata
  createdAt DateTime @default(now())

  @@index([questionPaperId])
  @@index([createdAt])
}

model Answer {
  id        String  @id @default(uuid())
  gradingId String
  grading   Grading @relation(fields: [gradingId], references: [id], onDelete: Cascade)

  // Answer details
  questionNumber String
  studentAnswer  String? @db.Text
  correct        Boolean
  score          String
  remarks        String  @db.Text

  // Matching info
  matched         Boolean @default(true)
  matchConfidence Float? // 0-1

  // Position in answer sheet (for annotations)
  positionX Float?
  positionY Float?

  // Metadata
  createdAt DateTime @default(now())

  @@index([gradingId])
}
