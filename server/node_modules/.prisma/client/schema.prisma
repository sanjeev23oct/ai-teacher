// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model QuestionPaper {
  id         String  @id @default(uuid())
  title      String? // Optional: "Math Final Exam 2024"
  subject    String // "Mathematics", "Physics", etc.
  gradeLevel String // "Grade 9-10"
  language   String // "English", "Hindi", etc.

  // Image storage
  imageUrl  String // URL or path to stored image
  imageHash String @unique // SHA-256 hash for deduplication

  // Extracted data
  questions      Question[]
  totalQuestions Int

  // Metadata
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  usageCount Int      @default(0) // How many times used

  // Relations
  gradings Grading[]

  @@index([imageHash])
  @@index([createdAt])
}

model Question {
  id              String        @id @default(uuid())
  questionPaperId String
  questionPaper   QuestionPaper @relation(fields: [questionPaperId], references: [id], onDelete: Cascade)

  // Question details
  questionNumber String // "1", "2", "3", etc.
  questionText   String  @db.Text
  maxScore       Float? // Optional: points for this question
  topic          String? // "Algebra", "Geometry", etc.
  concept        String? // "Linear Equations", etc.

  // Position in image (for annotations)
  positionX Float?
  positionY Float?

  // Metadata
  createdAt DateTime @default(now())

  @@unique([questionPaperId, questionNumber])
  @@index([questionPaperId])
}

model User {
  id           String @id @default(uuid())
  name         String
  email        String @unique
  passwordHash String

  // Profile
  grade  String? // "Grade 9", "Grade 10", etc.
  school String?

  // Language preference
  languagePreference String @default("en") // Language code: en, hi, ta, te, kn, ml, bn, pa

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  gradings              Grading[]
  doubts                Doubt[]
  worksheets            Worksheet[]
  doubtRatings          DoubtRating[]
  revisionSessions      RevisionSession[]
  weakTopics            WeakTopic[]
  groupStudySessions    GroupStudySession[]
  handlingSkillProgress HandlingSkillProgress?
  ncertChapterStudies   NCERTChapterStudy[]
  ncertProgress         NCERTProgress?

  @@index([email])
}

model Grading {
  id String @id @default(uuid())

  // User (optional for now, required later)
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Question paper (optional - null for single image mode)
  questionPaperId String?
  questionPaper   QuestionPaper? @relation(fields: [questionPaperId], references: [id])

  // Answer sheet (legacy for single page, kept for backward compatibility)
  answerSheetUrl String // URL or path to answer sheet image (first page or combined)

  // Multi-page support
  pages      GradingPage[]
  totalPages Int           @default(1)

  // Results
  subject    String
  language   String
  gradeLevel String
  totalScore String
  feedback   String @db.Text // Overall feedback across all pages

  // Matching info (for dual mode)
  matchingMode      String? // "single" | "dual"
  totalQuestions    Int?
  answeredQuestions Int?

  // Visual annotations (stored as JSON) - legacy for single page
  annotations     String? @db.Text // JSON string of annotations
  imageDimensions String? @db.Text // JSON string of {width, height}

  // Detailed analysis - legacy for single page
  answers Answer[]

  // Metadata
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([questionPaperId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model GradingPage {
  id        String  @id @default(uuid())
  gradingId String
  grading   Grading @relation(fields: [gradingId], references: [id], onDelete: Cascade)

  pageNumber      Int
  imageUrl        String
  annotations     String? @db.Text // JSON string of annotations for this page
  imageDimensions String? @db.Text // JSON string of {width, height}

  pageAnswers PageAnswer[]

  createdAt DateTime @default(now())

  @@unique([gradingId, pageNumber])
  @@index([gradingId])
}

model PageAnswer {
  id     String      @id @default(uuid())
  pageId String
  page   GradingPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Answer details
  questionNumber String
  studentAnswer  String? @db.Text
  correct        Boolean
  score          String
  remarks        String  @db.Text

  // Matching info
  matched         Boolean @default(true)
  matchConfidence Float? // 0-1

  // Position in answer sheet (for annotations)
  positionX Float?
  positionY Float?

  // Question continuity across pages
  continuedFrom Int? // Page number if continued from previous
  continuedTo   Int? // Page number if continues to next

  // Metadata
  createdAt DateTime @default(now())

  @@index([pageId])
}

model Answer {
  id        String  @id @default(uuid())
  gradingId String
  grading   Grading @relation(fields: [gradingId], references: [id], onDelete: Cascade)

  // Answer details
  questionNumber String
  studentAnswer  String? @db.Text
  correct        Boolean
  score          String
  remarks        String  @db.Text

  // Matching info
  matched         Boolean @default(true)
  matchConfidence Float? // 0-1

  // Position in answer sheet (for annotations)
  positionX Float?
  positionY Float?

  // Metadata
  createdAt DateTime @default(now())

  @@index([gradingId])
}

model Doubt {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Question
  questionImage String? // URL to stored image
  questionText  String  @db.Text
  subject       String // "Mathematics", "Physics", "Chemistry", etc.
  language      String // "English", "Hindi", "Hinglish", etc.

  // Explanation (stored as JSON)
  explanation     String  @db.Text // JSON of ExplanationResponse
  annotations     String? @db.Text // JSON of annotations array
  imageDimensions String? @db.Text // JSON of {width, height}

  // Conversation
  conversationId String         @unique
  messages       DoubtMessage[]

  // Worksheet relation
  worksheetId        String?
  worksheet          Worksheet?          @relation(fields: [worksheetId], references: [id])
  questionNumber     Int? // Question number within worksheet
  worksheetQuestions WorksheetQuestion[]

  // Revision
  isInRevision      Boolean   @default(false)
  addedToRevisionAt DateTime?

  // Rating
  rating DoubtRating?

  // Metadata
  isFavorite   Boolean  @default(false)
  messageCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([subject])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([worksheetId])
  @@index([userId, isInRevision])
}

model DoubtMessage {
  id      String @id @default(uuid())
  doubtId String
  doubt   Doubt  @relation(fields: [doubtId], references: [id], onDelete: Cascade)

  role     String // 'user' | 'assistant'
  content  String  @db.Text
  audioUrl String? // For TTS responses

  createdAt DateTime @default(now())

  @@index([doubtId])
  @@index([createdAt])
}

model Worksheet {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Image
  imageUrl  String
  imageHash String @unique

  // Questions
  totalQuestions  Int
  currentQuestion Int @default(1)

  // Session
  sessionId String   @unique
  expiresAt DateTime

  // Optional metadata
  title   String?
  subject String?

  // Relations
  questions WorksheetQuestion[]
  doubts    Doubt[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([sessionId])
  @@index([imageHash])
  @@index([createdAt])
}

model WorksheetQuestion {
  id          String    @id @default(uuid())
  worksheetId String
  worksheet   Worksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)

  questionNumber Int
  doubtId        String?
  doubt          Doubt?  @relation(fields: [doubtId], references: [id])

  // Status: 'pending' | 'explained' | 'skipped'
  status String @default("pending")

  // Cached explanation (JSON)
  cachedExplanation String? @db.Text

  createdAt DateTime @default(now())

  @@unique([worksheetId, questionNumber])
  @@index([worksheetId])
  @@index([doubtId])
}

model DoubtRating {
  id      String @id @default(uuid())
  doubtId String @unique
  doubt   Doubt  @relation(fields: [doubtId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id])

  // Rating (1-5)
  rating   Int
  feedback String? @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, doubtId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
}

model RevisionSession {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Session details
  topic   String
  subject String // "English", "Science", "Math", "SST"

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Performance
  score           Int? // Quiz score 0-5
  weakAreas       String? @db.Text // JSON array of weak areas identified
  phasesCompleted String? @db.Text // JSON array of completed phases

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, completedAt])
  @@index([userId, createdAt])
  @@index([subject])
}

model WeakTopic {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Topic details
  topic   String
  subject String // "English", "Science", "Math", "SST"

  // Tracking
  occurrences Int       @default(1)
  lastSeen    DateTime  @default(now())
  improved    Boolean   @default(false)
  improvedAt  DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, topic, subject])
  @@index([userId, improved])
  @@index([userId, lastSeen])
}

model GroupStudySession {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Session details
  topic    String
  subject  String // "English", "Science", "Math", "SST"
  question String? // Optional specific question

  // Classmate names (student-provided)
  classmate1Name String // First study buddy (questioner)
  classmate2Name String // Second study buddy (challenger)

  // Conversation data
  studentAnswer      String  @db.Text
  classmate1Question String? @db.Text
  classmate2Counter  String? @db.Text
  classmate1Response String? @db.Text // Student's response to classmate1
  classmate2Response String? @db.Text // Student's response to classmate2

  // Evaluation
  handlingScore   Int? // 1-5 scale
  strengths       String? @db.Text // JSON array
  improvements    String? @db.Text // JSON array
  challengesCount Int     @default(2)

  // Metadata
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, completedAt])
  @@index([userId, createdAt])
  @@index([subject])
}

model HandlingSkillProgress {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // Skill tracking
  currentLevel  String @default("supportive") // supportive, moderate, challenging
  avgScore      Float  @default(0) // Average handling score
  sessionsCount Int    @default(0)

  // Badges
  badges String @default("[]") @db.Text // JSON array of earned badges

  // Metadata
  lastSession DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model NCERTChapterStudy {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Chapter identification
  class       String // "6" to "10"
  subject     String // "English", "Science", "Math", "SST"
  chapterId   String
  chapterName String

  // Study tracking
  studiedAt        DateTime @default(now())
  revised          Boolean  @default(false)
  completedSummary Boolean  @default(false)
  followUpCount    Int      @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, class, subject, chapterId])
  @@index([userId, studiedAt])
  @@index([class, subject])
}

model NCERTProgress {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  totalChapters    Int      @default(0)
  completionBadges String   @default("[]") @db.Text // JSON array
  lastStudied      DateTime @default(now())

  // Subject-wise counts
  englishCount Int @default(0)
  scienceCount Int @default(0)
  mathCount    Int @default(0)
  sstCount     Int @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model AudioCacheRegistry {
  id       String @id @default(uuid())
  cacheKey String @unique

  // Cache key components
  module     String // "ncert", "revision", "doubts", "worksheets"
  subject    String?
  class      String?
  identifier String
  language   String  @default("en")
  version    String  @default("v1")

  // File info
  filePath       String
  fileSize       Int
  characterCount Int

  // Usage tracking
  generatedAt  DateTime @default(now())
  lastAccessed DateTime @default(now())
  accessCount  Int      @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([module, subject, class])
  @@index([lastAccessed])
  @@index([cacheKey])
}
