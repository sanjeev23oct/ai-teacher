// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model QuestionPaper {
  id             String   @id @default(uuid())
  title          String?  // Optional: "Math Final Exam 2024"
  subject        String   // "Mathematics", "Physics", etc.
  gradeLevel     String   // "Grade 9-10"
  language       String   // "English", "Hindi", etc.
  
  // Image storage
  imageUrl       String   // URL or path to stored image
  imageHash      String   @unique // SHA-256 hash for deduplication
  
  // Extracted data
  questions      Question[]
  totalQuestions Int
  
  // Metadata
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  usageCount     Int      @default(0) // How many times used
  
  // Relations
  gradings       Grading[]
  
  @@index([imageHash])
  @@index([createdAt])
}

model Question {
  id              String   @id @default(uuid())
  questionPaperId String
  questionPaper   QuestionPaper @relation(fields: [questionPaperId], references: [id], onDelete: Cascade)
  
  // Question details
  questionNumber  String   // "1", "2", "3", etc.
  questionText    String   @db.Text
  maxScore        Float?   // Optional: points for this question
  topic           String?  // "Algebra", "Geometry", etc.
  concept         String?  // "Linear Equations", etc.
  
  // Position in image (for annotations)
  positionX       Float?
  positionY       Float?
  
  // Metadata
  createdAt       DateTime @default(now())
  
  @@unique([questionPaperId, questionNumber])
  @@index([questionPaperId])
}

model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  passwordHash  String
  
  // Profile
  grade         String?  // "Grade 9", "Grade 10", etc.
  school        String?
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  gradings      Grading[]
  doubts        Doubt[]
  
  @@index([email])
}

model Grading {
  id              String   @id @default(uuid())
  
  // User (optional for now, required later)
  userId          String?
  user            User?    @relation(fields: [userId], references: [id])
  
  // Question paper (optional - null for single image mode)
  questionPaperId String?
  questionPaper   QuestionPaper? @relation(fields: [questionPaperId], references: [id])
  
  // Answer sheet (legacy for single page, kept for backward compatibility)
  answerSheetUrl  String   // URL or path to answer sheet image (first page or combined)
  
  // Multi-page support
  pages           GradingPage[]
  totalPages      Int      @default(1)
  
  // Results
  subject         String
  language        String
  gradeLevel      String
  totalScore      String
  feedback        String   @db.Text // Overall feedback across all pages
  
  // Matching info (for dual mode)
  matchingMode    String?  // "single" | "dual"
  totalQuestions  Int?
  answeredQuestions Int?
  
  // Visual annotations (stored as JSON) - legacy for single page
  annotations     String?  @db.Text // JSON string of annotations
  imageDimensions String?  @db.Text // JSON string of {width, height}
  
  // Detailed analysis - legacy for single page
  answers         Answer[]
  
  // Metadata
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([questionPaperId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model GradingPage {
  id              String      @id @default(uuid())
  gradingId       String
  grading         Grading     @relation(fields: [gradingId], references: [id], onDelete: Cascade)
  
  pageNumber      Int
  imageUrl        String
  annotations     String?     @db.Text // JSON string of annotations for this page
  imageDimensions String?     @db.Text // JSON string of {width, height}
  
  pageAnswers     PageAnswer[]
  
  createdAt       DateTime    @default(now())
  
  @@unique([gradingId, pageNumber])
  @@index([gradingId])
}

model PageAnswer {
  id              String      @id @default(uuid())
  pageId          String
  page            GradingPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  // Answer details
  questionNumber  String
  studentAnswer   String?     @db.Text
  correct         Boolean
  score           String
  remarks         String      @db.Text
  
  // Matching info
  matched         Boolean     @default(true)
  matchConfidence Float?      // 0-1
  
  // Position in answer sheet (for annotations)
  positionX       Float?
  positionY       Float?
  
  // Question continuity across pages
  continuedFrom   Int?        // Page number if continued from previous
  continuedTo     Int?        // Page number if continues to next
  
  // Metadata
  createdAt       DateTime    @default(now())
  
  @@index([pageId])
}

model Answer {
  id              String   @id @default(uuid())
  gradingId       String
  grading         Grading  @relation(fields: [gradingId], references: [id], onDelete: Cascade)
  
  // Answer details
  questionNumber  String
  studentAnswer   String?  @db.Text
  correct         Boolean
  score           String
  remarks         String   @db.Text
  
  // Matching info
  matched         Boolean  @default(true)
  matchConfidence Float?   // 0-1
  
  // Position in answer sheet (for annotations)
  positionX       Float?
  positionY       Float?
  
  // Metadata
  createdAt       DateTime @default(now())
  
  @@index([gradingId])
}

model Doubt {
  id              String   @id @default(uuid())
  userId          String?
  user            User?    @relation(fields: [userId], references: [id])
  
  // Question
  questionImage   String?  // URL to stored image
  questionText    String   @db.Text
  subject         String   // "Mathematics", "Physics", "Chemistry", etc.
  language        String   // "English", "Hindi", "Hinglish", etc.
  
  // Explanation (stored as JSON)
  explanation     String   @db.Text // JSON of ExplanationResponse
  annotations     String?  @db.Text // JSON of annotations array
  imageDimensions String?  @db.Text // JSON of {width, height}
  
  // Conversation
  conversationId  String   @unique
  messages        DoubtMessage[]
  
  // Metadata
  isFavorite      Boolean  @default(false)
  messageCount    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([subject])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model DoubtMessage {
  id              String   @id @default(uuid())
  doubtId         String
  doubt           Doubt    @relation(fields: [doubtId], references: [id], onDelete: Cascade)
  
  role            String   // 'user' | 'assistant'
  content         String   @db.Text
  audioUrl        String?  // For TTS responses
  
  createdAt       DateTime @default(now())
  
  @@index([doubtId])
  @@index([createdAt])
}
